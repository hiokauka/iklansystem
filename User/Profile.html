<!DOCTYPE html>
<html lang="ms">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tetapan | AdSpace</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: "Montserrat", sans-serif;
      background-color: #f8f9fa;

    }

    .settings-container {
      max-width: 600px;
      margin: 0 auto;
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }

    .settings-container h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #0d6efd;
    }

    .settings-container label {
      display: block;
      font-weight: 500;
      margin-top: 15px;
    }

    .settings-container input {
      width: 100%;
      padding: 8px 12px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ced4da;
    }

    .submitchange {
      margin-top: 20px;
      width: 100%;
      padding: 10px;
      background-color: #0d6efd;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: 500;
      cursor: pointer;
    }

    .submitchange:hover {
      background-color: #0b5ed7;
    }

    body {
      font-family: "Montserrat", sans-serif;
    }

    .sidebar {
      width: 250px;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      background: white;
      padding: 1rem;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 1050;
    }


    button {
      padding: 5px 10px;
      background-color: #1a093c;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #0b5ed7;
    }

    .btn-navbar {
      font-size: 24px;
      background: none;
      border: white solid 2px;
      border-radius: 8px;
      cursor: pointer;
      color: white;
    }

    .title {
      font-weight: 700;
      font-size: 2.2rem;
      color: #ffffff;
      margin-top: 15px;
      margin-left: 450px;
    }

    header {
      background: #1a093c;
    }

    nav a {
      font-size: 20px;
      padding: 10px 0;
    }
  </style>
</head>

<body>

  <script>
    // Check if the user is logged in
    const isLoggedIn = localStorage.getItem('userLoggedIn')
    if (!isLoggedIn) {
      // Redirect to login page if not logged in
      window.location.href = '/index.html'
    }
  </script>


  <header class="mb-4 p-3  shadow-sm d-flex flex-column flex-md-row ">
    <div class="d-flex flex-row align-items-center">
      <button class="btn-navbar" id="toggleSidebar">☰</button>
      <h1 class=" title">Hub Pengiklanan Digital</h1>
    </div>
  </header>

  <div class="sidebar" id="sidebar">
    <button class="btn-close mb-3" id="closeSidebar"></button>
    <nav class="d-flex flex-column my-4">
      <a href="/User/Uhome.html" class="mb-2 text-decoration-none text-dark">Laman Utama</a>
      <a href="/User/Bonus.html" class="mb-2 text-decoration-none text-dark">Bonus</a>
      <a href="/User/Network.html" class="mb-2 text-decoration-none text-dark">Rangkaian</a>
      <a href="/User/Profile.html" class="mb-2 text-decoration-none text-dark">Profile</a>
      <a href="#" id="logoutLink" class="mb-2 text-decoration-none" style="color: red;">Log Keluar</a>
    </nav>
  </div>

  <div class="settings-container">
    <h2 style="color: #1a093c;">Tetapan</h2>
    <form id="settingsForm">

      <label>Username</label>
      <input id="username" type="text"  readonly />

      <label>Nama Penuh</label>
      <input id="fullname" type="text" readonly />


      <label>Pin</label>
      <input id="pin" type="text" readonly />

      <label>Nombor Telefon</label>
      <input id="phone" type="text"  readonly />

      <label>Nama Bank</label>
      <input id="bankname" type="text"  readonly />

      <label>Nombor Akaun Bank</label>
      <input id="bankacc" type="text"  readonly />

      <button class="submitchange" id="editBtn" type="button">
        Kemaskini
      </button>
    </form>
  </div>





  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const toggleBtn = document.getElementById('toggleSidebar');
    const closeBtn = document.getElementById('closeSidebar');
    const sidebar = document.getElementById('sidebar');

    toggleBtn.addEventListener('click', () => {
      sidebar.style.display = 'block';
    });
    closeBtn.addEventListener('click', () => {
      sidebar.style.display = 'none';
    });
  </script>


  <script>
    const logoutLink = document.getElementById('logoutLink');

    logoutLink.addEventListener('click', (e) => {
      e.preventDefault();

      // Show confirmation dialog
      const confirmed = confirm("Adakah anda pasti mahu log keluar?");
      if (!confirmed) return; // Stop if user cancels

      // Clear localStorage login flags
      localStorage.removeItem('userLoggedIn');
      localStorage.removeItem('username');

      // Redirect to login page
      window.location.href = '/index.html';
    });
  </script>


  <script type="module">
    import { supabase } from '/supabase.js';

    const form = document.getElementById("settingsForm");
    const editBtn = document.getElementById("editBtn");
    const inputs = form.querySelectorAll("input");

    // Get logged in username
    const username = localStorage.getItem("username");
    if (!username) {
      window.location.href = "/index.html";
    }

    // Load Data from Supabase
    async function loadUserData() {
      const { data, error } = await supabase
        .from("users")
        .select("*")
        .eq("username", username)
        .single();

      if (error) {
        console.error("Error fetching data:", error);
        return;
      }

      // Fill form fields
      document.getElementById("username").value = data.username;
      document.getElementById("fullname").value = data.name;
      
      document.getElementById("pin").value = data.pin;
      document.getElementById("phone").value = data.number_telephone;
      document.getElementById("bankname").value = data.bank_name;
      document.getElementById("bankacc").value = data.bank_num;
    }

    loadUserData();

    // Enable Edit Mode When Form Clicked
    form.addEventListener("click", () => {
      if (editBtn.disabled) {
        editBtn.disabled = false;
        editBtn.style.backgroundColor = "#0d6efd";
      }
    });

    let editMode = false;

    editBtn.addEventListener("click", async () => {
      editMode = !editMode;

      if (editMode) {
        // Make fields editable except username & pin
        inputs.forEach(input => {
          const label = input.previousElementSibling.innerText;
          if (label !== "Username" && label !== "Pin") {
            input.removeAttribute("readonly");
            input.style.color = "black"; // ✅ remove grey look when editable
          }
        });

        editBtn.innerText = "Simpan Perubahan";
        editBtn.style.backgroundColor = "#198754"; // green

      } else {
        // Lock fields back
        inputs.forEach(input => input.setAttribute("readonly", true));

        editBtn.innerText = "Kemaskini";
        editBtn.style.backgroundColor = "#0d6efd";

        // ✅ Save to Supabase
        const { error } = await supabase
          .from("users")
          .update({
            name: document.getElementById("fullname").value,
            number_telephone: document.getElementById("phone").value,
            bank_name: document.getElementById("bankname").value,
            bank_num: document.getElementById("bankacc").value
          })
          .eq("username", username);

        if (error) {
          alert("Ralat semasa menyimpan perubahan.");
          console.error(error);
        } else {
          alert("Perubahan berjaya disimpan! ✅");
        }
      }
    });
  </script>


</body>

</html>