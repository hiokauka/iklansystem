<!DOCTYPE html>
<html lang="ms">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jana Pin | AdSpace</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: "Montserrat", sans-serif;
      font-size: 18px;
      background: #ffffff;
      color: #222;
      margin: 0;
      padding: 0;
    }

    header {
      background: #1a093c;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      padding: 10px 15px;
    }

    .title {
      font-weight: 700;
      font-size: 2rem;
      color: #ffffff;
      margin: 10px 0;
      text-align: center;
      flex: 1;
    }

    .sidebar {
      width: 260px;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      background: white;
      padding: 1.5rem;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 1050;
      overflow-y: auto;
    }

    .container-display {
      text-align: center;
      margin: 20px auto;
      padding: 0 10px;
    }

    .container-display h2 {
      font-size: 2rem;
      font-weight: bold;
      color: #0d6efd;
      word-break: break-word;
    }

    .container-display button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 1rem;
    }

    .jana-filters {
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      padding: 0 10px;
    }

    .jana-filters input {
      width: 100%;
      max-width: 300px;
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }

    .jana-table-container {
      margin-top: 20px;
      padding: 0 10px;
    }

    .table-wrapper1 {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      padding: 10px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      text-align: center;
      padding: 8px;
      font-size: 0.9rem;
    }

    th {
      background-color: #0d6efd;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    .total-pin {
      margin-top: 15px;
      font-weight: 500;
    }

    .btn-navbar {
      font-size: 24px;
      background: none;
      border: white solid 2px;
      border-radius: 8px;
      cursor: pointer;
      color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .title {
        font-size: 1.5rem;
        margin: 10px 5px;
      }

      .container-display h2 {
        font-size: 1.8rem;
      }

      .container-display button {
        width: 80%;
      }

      .jana-filters input {
        max-width: 100%;
      }

      .table-wrapper1 {
        padding: 5px;
      }

      th,
      td {
        padding: 6px;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .title {
        font-size: 1.3rem;
      }

      .container-display h2 {
        font-size: 1.5rem;
      }

      .container-display button {
        font-size: 0.9rem;
        padding: 8px 12px;
      }

      th,
      td {
        padding: 4px;
        font-size: 0.75rem;
      }
    }
  </style>
</head>

<body>

  <header class="mb-4 p-3 shadow-sm  d-flex flex-column flex-md-row">

    <button class="btn-navbar mt-3" id="toggleSidebar">â˜°</button>
    <h1 class="  title "> HUB PENGIKLANAN DIGITAL</h1>

  </header>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="btn-close mb-3" id="closeSidebar"></button>
    <nav class="d-flex flex-column my-4">
      <a href="/Admin/Ahome.html" class="mb-2 text-decoration-none text-dark">Laman Utama</a>

      <a href="/Admin/Payment.html" class="mb-2 text-decoration-none text-dark">Pembayaran Bonus</a>

      <a href="/Admin/Iklan.html" class="mb-2 text-decoration-none text-dark">Tambah Iklan</a>

      <a href="/Admin/Pin.html" class="mb-2 text-decoration-none text-dark">Jana Pin</a>

      <a href="#" id="logoutLink" class="mb-2 text-decoration-none" style="color: red;">Log Keluar</a>
    </nav>
  </div>


  <div class="container-display">
    <h2 id="pinDisplay" style="color: #1a093c;">------</h2>
    <button id="generateBtn" class="btn btn-primary">Hasilkan Nombor PIN</button>
    <h1>Total pins terjual hari ini: <span id="totalPins">0</span></h1>

  </div>

  <div class="jana-filters">
    <input type="text" placeholder="Carian nombor pin..." />
  </div>

  <div class="jana-table-container">
    <div class="table-wrapper1">
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Nombor Pin</th>

            <th>Tarikh Berdaftar</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="pinTableBody"></tbody>

        </tbody>
      </table>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>




  <script>

    const username = localStorage.getItem("username");
    if (!username) {
      window.location.href = "/index.html";
    }

    const toggleBtn = document.getElementById('toggleSidebar');
    const closeBtn = document.getElementById('closeSidebar');
    const sidebar = document.getElementById('sidebar');

    toggleBtn.addEventListener('click', () => {
      sidebar.style.display = 'block';
    });
    closeBtn.addEventListener('click', () => {
      sidebar.style.display = 'none';
    });
  </script>

  <script>
    const logoutLink = document.getElementById('logoutLink');

    logoutLink.addEventListener('click', (e) => {
      e.preventDefault();

      // Show confirmation dialog
      const confirmed = confirm("Adakah anda pasti mahu log keluar?");
      if (!confirmed) return; // Stop if user cancels

      // Clear localStorage login flags
      localStorage.removeItem('userLoggedIn');
      localStorage.removeItem('username');

      // Redirect to login page
      window.location.href = '/index.html';
    });
  </script>

  <script type="module">
    import { supabase } from '/supabase.js';

    const totalPinsSpan = document.getElementById("totalPins");
    const generateBtn = document.getElementById("generateBtn");
    const pinDisplay = document.getElementById("pinDisplay");
    const pinTableBody = document.getElementById("pinTableBody");

    // Fetch total pins today
    const fetchTotalPinsToday = async () => {
      const today = new Date();
      const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);

      const { count, error } = await supabase
        .from("pins")
        .select("pin_code", { count: "exact", head: true })
        .gte("created_at", startOfDay.toISOString())
        .lt("created_at", endOfDay.toISOString());

      if (error) {
        console.error("Error fetching total pins today:", error);
        totalPinsSpan.textContent = "Error";
        return;
      }

      totalPinsSpan.textContent = count;
    };

    // Load all pins into table
    const loadPins = async () => {
      const { data: pins, error } = await supabase
        .from("pins")
        .select("pin_code, status, created_at")
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        return;
      }

      pinTableBody.innerHTML = "";
      pins.forEach(pin => {
        const date = new Date(pin.created_at).toLocaleString('ms-MY', {
          day: '2-digit', month: '2-digit', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        });

        const statusText = pin.status === "unused"
          ? `<span style="color:red; font-weight:bold;">Belum Digunakan</span>`
          : `<span style="color:green; font-weight:bold;">Telah Digunakan</span>`;

        pinTableBody.innerHTML += `
      <tr>
        <td>${pin.pin_code}</td>
        <td>${date}</td>
        <td>${statusText}</td>
      </tr>
    `;
      });
    };

    // Generate PIN
    generateBtn.addEventListener("click", async () => {
      const pin = Math.floor(100000 + Math.random() * 900000);
      pinDisplay.textContent = pin;

      const { error } = await supabase
        .from("pins")
        .insert([{ pin_code: pin, status: "unused" }]);

      if (error) {
        console.error(error);
        alert("Ralat semasa menyimpan PIN.");
        return;
      }

      // Update total pins and refresh table
      fetchTotalPinsToday();
      loadPins();
    });

    // Initial load
    fetchTotalPinsToday();
    loadPins();
  </script>


</body>

</html>